<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Video Satellite 8.0 (Debug Mode)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #111; color: #eee; }
        
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #playlist-section { width: 250px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; overflow-y: auto; }
        .clip-item { padding: 10px; border-bottom: 1px solid #2a2a2a; cursor: pointer; color: #ccc; font-size: 0.85em; }
        .clip-item.active { background: #004466; color: #fff; border-left: 4px solid #4facfe; }

        #video-section { flex: 2; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: contain; }

        #map-section { flex: 1; min-width: 300px; }
        #map { width: 100%; height: 100%; background: #222; }

        #controls { padding: 10px; background: #222; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; border-bottom: 1px solid #444; }
        .btn { background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .hud { margin-left: auto; display: flex; gap: 15px; font-family: 'Consolas', monospace; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-val { color: #4facfe; font-weight: bold; font-size: 1.1em; }
        .stat-lbl { font-size: 0.7em; color: #888; }
        
        /* DEBUG PANEL */
        #debug-panel { 
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); 
            padding: 10px; font-family: monospace; font-size: 10px; color: #0f0; 
            pointer-events: none; z-index: 2000; border: 1px solid #0f0; display: none;
        }

        .runner-icon { width: 20px; height: 20px; background: #4facfe; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px black; }
        .sync-adj { display: flex; align-items: center; gap: 5px; font-size: 0.8em; color: #aaa; border-left: 1px solid #444; padding-left: 15px; }
    </style>
</head>
<body>

    <div id="debug-panel">
        <div>TRACK START: <span id="dbg-track">0</span></div>
        <div>VIDEO START: <span id="dbg-video">0</span></div>
        <div>OFFSET: <span id="dbg-offset">0</span></div>
        <div>GLOBAL T: <span id="dbg-global">0</span></div>
    </div>

    <div id="controls">
        <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Load Files</button>
        <input type="file" id="fileInput" multiple accept=".json, .webm, .mp4, .mov" style="display:none;">
        
        <button class="btn" onclick="toggleDebug()">üêû Debug</button>

        <div class="sync-adj">
            <span>Sync:</span>
            <input type="range" id="syncOffset" min="-300" max="300" step="1" value="0">
            <span id="offsetVal">0s</span>
        </div>

        <div class="hud">
            <div class="stat-item"><span class="stat-val" id="dispTime">00:00</span><span class="stat-lbl">GPS T</span></div>
            <div class="stat-item"><span class="stat-val" id="dispVel">0.0</span><span class="stat-lbl">KM/H</span></div>
            <div class="stat-item"><span class="stat-val" id="dispAcc" style="color:#ff0055;">0.0</span><span class="stat-lbl">ACC</span></div>
            <div class="stat-item"><span class="stat-val" id="dispHead" style="color:#ffd700;">0¬∞</span><span class="stat-lbl">HEAD</span></div>
        </div>
    </div>

    <div id="main-container">
        <div id="playlist-section"><div id="playlist-content" style="padding:10px;">No files</div></div>
        <div id="video-section"><video id="main-player" controls playsinline></video></div>
        <div id="map-section"><div id="map"></div></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        const pathLayer = L.polyline([], {color: '#4facfe', weight: 4, opacity: 0.8}).addTo(map);
        let syncMarker = null;
        
        let trackPoints = [];
        let trackStartEpoch = 0;
        let videoClips = [];
        let currentClipIndex = -1;
        const player = document.getElementById('main-player');
        const syncChannel = new BroadcastChannel('song_sync_channel');

        function toggleDebug() {
            const p = document.getElementById('debug-panel');
            p.style.display = (p.style.display === 'none') ? 'block' : 'none';
        }

        document.getElementById('syncOffset').addEventListener('input', (e) => {
            document.getElementById('offsetVal').innerText = e.target.value + 's';
        });

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            const jsonFile = files.find(f => f.name.toLowerCase().endsWith('.json'));
            const vidFiles = files.filter(f => f.name.match(/\.(webm|mp4|mov)$/i));

            if (!jsonFile || vidFiles.length === 0) { alert("Need JSON + Video"); return; }

            // 1. PROCESS TRACK
            const text = await jsonFile.text();
            try {
                const data = JSON.parse(text);
                trackPoints = data.track_points || data.points;
                
                // CRITICAL: Find absolute start time of the GPS track
                if (trackPoints[0] && trackPoints[0].absTime) {
                    trackStartEpoch = trackPoints[0].absTime;
                    console.log("Track Start (Epoch):", trackStartEpoch);
                } else {
                    alert("Warning: JSON lacks 'absTime'. Sync will fail.");
                    trackStartEpoch = Date.now();
                }

                processTrack();
            } catch(err) { alert("JSON Error"); return; }

            // 2. PROCESS VIDEOS
            videoClips = vidFiles.map(f => {
                let vidEpoch = 0;
                // Regex for Video_YYYY-MM-DD-HH-MM-SS
                const match = f.name.match(/Video_(\d{4}-\d{2}-\d{2})[T_](\d{2})-(\d{2})-(\d{2})/);
                
                if (match) {
                    const isoStr = `${match[1]}T${match[2]}:${match[3]}:${match[4]}`;
                    vidEpoch = new Date(isoStr).getTime();
                } else {
                    // Fallback to file date (often unreliable if file moved/copied)
                    vidEpoch = f.lastModified; 
                }

                return {
                    file: f,
                    name: f.name,
                    startTimeMs: vidEpoch,
                    // Offset = Video Start - GPS Start
                    offsetSeconds: (vidEpoch - trackStartEpoch) / 1000
                };
            });

            videoClips.sort((a, b) => a.startTimeMs - b.startTimeMs);
            buildPlaylist();
            loadClip(0);
        });

        function buildPlaylist() {
            const c = document.getElementById('playlist-content');
            c.innerHTML = '';
            videoClips.forEach((clip, i) => {
                const div = document.createElement('div');
                div.className = 'clip-item';
                div.innerHTML = `<div>${clip.name}</div><div style="font-size:0.7em; color:#888;">Offset: ${clip.offsetSeconds.toFixed(1)}s</div>`;
                div.onclick = () => loadClip(i);
                div.id = `clip-${i}`;
                c.appendChild(div);
            });
        }

        function loadClip(i) {
            if (i < 0 || i >= videoClips.length) return;
            currentClipIndex = i;
            
            document.querySelectorAll('.clip-item').forEach(d => d.classList.remove('active'));
            document.getElementById(`clip-${i}`).classList.add('active');
            
            player.src = URL.createObjectURL(videoClips[i].file);
            // Reset offset slider to 0 on new clip to avoid confusion
            document.getElementById('syncOffset').value = 0;
            document.getElementById('offsetVal').innerText = "0s";
            
            player.play();
        }

        function processTrack() {
            const latLngs = trackPoints.map(p => [p.lat||p.latitude, p.lng||p.longitude]);
            pathLayer.setLatLngs(latLngs);
            if(latLngs.length>0) {
                map.fitBounds(pathLayer.getBounds());
                if(syncMarker) map.removeLayer(syncMarker);
                syncMarker = L.marker(latLngs[0], {
                    icon: L.divIcon({className:'', html:`<div class="runner-icon"></div>`, iconSize:[20,20]}),
                    zIndexOffset:1000
                }).addTo(map);
            }
        }

        player.ontimeupdate = () => {
            if (currentClipIndex === -1 || trackPoints.length < 2) return;
            
            const clip = videoClips[currentClipIndex];
            const manual = parseFloat(document.getElementById('syncOffset').value);
            
            // GLOBAL TIME CALCULATION
            // First point relative time + Clip Offset + Video Playhead + Manual Slider
            const firstRel = trackPoints[0].time || 0; 
            const globalTime = firstRel + clip.offsetSeconds + player.currentTime + manual;

            // Update Debug Panel
            document.getElementById('dbg-track').innerText = trackStartEpoch;
            document.getElementById('dbg-video').innerText = clip.startTimeMs;
            document.getElementById('dbg-offset').innerText = clip.offsetSeconds.toFixed(1);
            document.getElementById('dbg-global').innerText = globalTime.toFixed(1);

            updateMapPosition(globalTime);
            syncChannel.postMessage({ type: 'sync_time', time: globalTime });

            const m = Math.floor(Math.max(0, globalTime)/60);
            const s = Math.floor(Math.max(0, globalTime)%60);
            document.getElementById('dispTime').innerText = `${m}:${s.toString().padStart(2,'0')}`;
        };

        player.onended = () => {
            if (currentClipIndex < videoClips.length - 1) loadClip(currentClipIndex + 1);
        };

        function updateMapPosition(t) {
            let idx = -1;
            for(let i=0; i < trackPoints.length-1; i++) {
                if (t >= trackPoints[i].time && t <= trackPoints[i+1].time) {
                    idx = i; break;
                }
            }

            if (idx !== -1) {
                const p1 = trackPoints[idx]; const p2 = trackPoints[idx+1];
                const f = (t - p1.time) / (p2.time - p1.time); 
                
                const lat = (p1.lat||p1.latitude) + ((p2.lat||p2.latitude)-(p1.lat||p1.latitude))*f;
                const lng = (p1.lng||p1.longitude) + ((p2.lng||p2.longitude)-(p1.lng||p1.longitude))*f;
                
                if(syncMarker) syncMarker.setLatLng([lat, lng]);
                if(!map.getBounds().contains([lat,lng])) map.panTo([lat,lng]);

                const v = (p1.vel + (p2.vel - p1.vel) * f) * 3.6;
                const a = (p1.acc||0) + ((p2.acc||0) - (p1.acc||0)) * f;
                
                // Heading
                let h1 = p1.heading||0; let h2 = p2.heading||0;
                if (h2 - h1 > 180) h2 -= 360; if (h1 - h2 > 180) h1 -= 360;
                let h = h1 + (h2 - h1) * f; if (h < 0) h += 360;

                document.getElementById('dispVel').innerText = v.toFixed(1);
                document.getElementById('dispAcc').innerText = a.toFixed(2);
                document.getElementById('dispHead').innerText = Math.round(h)+"¬∞";
            }
        }
    </script>
</body>
</html>