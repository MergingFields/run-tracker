<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; }
        .session-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .meta { color: #aaa; font-size: 14px; margin-bottom: 10px; }
        .stats { display: flex; gap: 15px; font-size: 12px; font-family: monospace; color: #4fceff; margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-json { background: #4fceff; color: #000; }
        .btn-vid { background: #ff4444; color: #fff; }
        .btn-del { background: #333; color: #aaa; max-width: 50px; }
        .empty-msg { color: #555; text-align: center; margin-top: 50px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #aaa; text-decoration: none; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Menu</a>
    <h1>üìÇ Saved Sessions</h1>
    <div id="list">Loading...</div>

    <script>
        const list = document.getElementById('list');

        // --- OPEN VERSION 99 ---
        const request = indexedDB.open("RunTrackerDB", 99);
        
        request.onsuccess = function(e) {
            const db = e.target.result;
            if(!db.objectStoreNames.contains("sessions")) {
                list.innerHTML = "<div class='empty-msg'>Database Reset. Record a new run!</div>";
                return;
            }
            loadSessions(db);
        };

        request.onerror = function() {
            list.innerHTML = "Error accessing database.";
        };

        function loadSessions(db) {
            const tx = db.transaction("sessions", "readonly");
            const store = tx.objectStore("sessions");
            const getAll = store.getAll();

            getAll.onsuccess = function() {
                const runs = getAll.result;
                if(runs.length === 0) {
                    list.innerHTML = "<div class='empty-msg'>No saved runs yet.</div>";
                    return;
                }
                runs.sort((a,b) => new Date(b.date) - new Date(a.date));
                renderList(runs, db);
            };
        }

        function renderList(runs, db) {
            list.innerHTML = '';
            runs.forEach(run => {
                const date = new Date(run.date).toLocaleString();
                const duration = formatTime(run.duration || 0);
                const pts = run.track_points ? run.track_points.length : 0;
                const photos = run.photos ? run.photos.length : 0;
                const hasVideo = !!run.videoBlob;
                const vidSize = hasVideo ? (run.videoBlob.size / 1024 / 1024).toFixed(1) + " MB" : "No Video";

                const card = document.createElement('div');
                card.className = 'session-card';
                card.innerHTML = `
                    <div class="meta">${date}</div>
                    <div class="stats">
                        <span>‚è± ${duration}</span>
                        <span>üìç ${pts} Pts</span>
                        <span>üì∏ ${photos}</span>
                        <span>üíæ ${vidSize}</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-json" onclick="downloadJSON(${run.id})">JSON</button>
                        ${hasVideo ? `<button class="btn-vid" onclick="downloadVideo(${run.id})">VIDEO</button>` : ''}
                        <button class="btn-del" onclick="deleteRun(${run.id})">üóë</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function downloadJSON(id) {
            useDB(store => {
                const req = store.get(id);
                req.onsuccess = () => {
                    const data = req.result;
                    const { videoBlob, ...jsonData } = data; 
                    const blob = new Blob([JSON.stringify(jsonData, null, 2)], {type : 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Run_${data.date.replace(/:/g,'-')}.json`;
                    a.click();
                };
            });
        }

        function downloadVideo(id) {
            useDB(store => {
                const req = store.get(id);
                req.onsuccess = () => {
                    const data = req.result;
                    if(!data.videoBlob) return alert("No video in this session.");
                    const url = URL.createObjectURL(data.videoBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    const ext = data.videoBlob.type.includes('mp4') ? 'mp4' : 'webm';
                    a.download = `Video_${data.date.replace(/:/g,'-')}.${ext}`;
                    a.click();
                };
            });
        }

        function deleteRun(id) {
            if(!confirm("Delete this run permanently?")) return;
            const req = indexedDB.open("RunTrackerDB", 99); 
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction("sessions", "readwrite");
                tx.objectStore("sessions").delete(id);
                tx.oncomplete = () => loadSessions(db);
            };
        }

        function useDB(callback) {
            const req = indexedDB.open("RunTrackerDB", 99); 
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction("sessions", "readonly");
                callback(tx.objectStore("sessions"));
            };
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = (sec % 60).toString().padStart(2,'0');
            return `${m}:${s}`;
        }
    </script>
</body>
</html>