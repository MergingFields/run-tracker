<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Viewer - Robust Sync</title>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #video-container {
            position: relative;
            width: 80%;
            max-width: 1000px;
            border: 2px solid #333;
            background: #111;
        }

        video {
            width: 100%;
            display: block;
        }

        /* Overlay for lyrics or future drawing canvas */
        #overlay-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through to video controls */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #lyric-display {
            font-size: 2em;
            text-align: center;
            text-shadow: 2px 2px 4px #000;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
        }

        /* Debug Box Styling */
        #debug-box {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #444;
            padding: 10px;
            font-size: 12px;
            z-index: 9999;
            width: 300px;
            pointer-events: auto;
        }

        .debug-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
        }

        .debug-label { color: #aaa; }
        .debug-val { color: #0f0; font-weight: bold; }
        .debug-err { color: #f55; }
    </style>
</head>
<body>

    <div id="debug-box">
        <div style="text-align:center; margin-bottom:5px; color:#fff;">DEBUGGER</div>
        <div class="debug-row"><span class="debug-label">Status:</span><span id="dbg-status" class="debug-val">Init</span></div>
        <div class="debug-row"><span class="debug-label">Track Start:</span><span id="dbg-track-start" class="debug-val">WAITING</span></div>
        <div class="debug-row"><span class="debug-label">Server Time:</span><span id="dbg-server-time" class="debug-val">0</span></div>
        <div class="debug-row"><span class="debug-label">Video Target:</span><span id="dbg-vid-target" class="debug-val">0.00</span></div>
        <div class="debug-row"><span class="debug-label">Video Actual:</span><span id="dbg-vid-actual" class="debug-val">0.00</span></div>
        <div class="debug-row"><span class="debug-label">Drift:</span><span id="dbg-drift" class="debug-val">0</span></div>
    </div>

    <div id="start-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center; cursor:pointer;">
        <div style="border: 2px solid white; padding: 20px; font-size: 24px;">
            CLICK HERE TO ENABLE VIDEO
        </div>
    </div>

    <div id="video-container">
        <video id="main-video" playsinline>
            </video>
<div id="overlay-layer">
    <div id="lyric-display">Waiting for sync...</div>
    
    <div id="sync-marker" style="
        position: absolute; 
        top: 50%; 
        left: 0%; 
        width: 20px; 
        height: 20px; 
        background-color: red; 
        border-radius: 50%; 
        transform: translate(-50%, -50%);
        transition: left 0.1s linear;"></div>
</div>    </div>

    <script>
        // --- CONFIGURATION ---
        const urlParams = new URLSearchParams(window.location.search);
        const SONG_ID = urlParams.get('songId') || 'Video_2026-01-11T19-09-44.webm';
        const VIDEO_SRC = `/media/videos/${SONG_ID}`; 

        // --- STATE ---
        const state = {
            trackStartTime: 0,
            serverTime: 0,
            isPlaying: false,
            localVideoLoaded: false,
            userHasInteracted: false // New flag
        };

        const els = {
            video: document.getElementById('main-video'),
            lyrics: document.getElementById('lyric-display'),
            marker: document.getElementById('sync-marker'),
            startOverlay: document.getElementById('start-overlay'), // New element
            debug: {
                status: document.getElementById('dbg-status'),
                trackStart: document.getElementById('dbg-track-start'),
                serverTime: document.getElementById('dbg-server-time'),
                target: document.getElementById('dbg-vid-target'),
                actual: document.getElementById('dbg-vid-actual'),
                drift: document.getElementById('dbg-drift'),
            }
        };

        // --- INITIALIZATION ---
        function init() {
            els.video.src = VIDEO_SRC;
            
            // 1. Force user interaction to allow audio/video
            els.startOverlay.addEventListener('click', () => {
                state.userHasInteracted = true;
                els.startOverlay.style.display = 'none';
                els.video.play().then(() => {
                    els.video.pause(); // Pause immediately, wait for sync
                    els.debug.status.innerText = "Ready for Sync";
                }).catch(e => console.error(e));
            });

            els.video.addEventListener('loadedmetadata', () => {
                state.localVideoLoaded = true;
            });

            requestAnimationFrame(syncLoop);
            setInterval(fetchSyncData, 1000);
        }

        // --- DATA FETCHING ---
        async function fetchSyncData() {
            try {
                const response = await fetch('/api/sync-status.json?nocache=' + Date.now());
                const data = await response.json();
                
                // IMPORTANT: Only update if track has actually started (non-zero)
                if (data.trackStartTime > 0) {
                    state.trackStartTime = parseInt(data.trackStartTime, 10);
                    state.isPlaying = data.isPlaying;
                    els.debug.trackStart.innerText = state.trackStartTime;
                    els.debug.trackStart.style.color = "#0f0";
                } else {
                    els.debug.trackStart.innerText = "WAITING (0)";
                    els.debug.trackStart.style.color = "orange";
                }
                
            } catch (err) {
                els.debug.status.innerText = "Fetch Error";
                els.debug.status.classList.add('debug-err');
            }
        }

function syncLoop() {
            const now = Date.now();
            state.serverTime = now;
            els.debug.serverTime.innerText = now;

            if (state.trackStartTime > 0 && state.userHasInteracted) {
                
                // 1. Calculate Time
                const offsetMs = now - state.trackStartTime;
                const targetVideoTimeSec = offsetMs / 1000;

                els.debug.target.innerText = targetVideoTimeSec.toFixed(3);
                els.debug.actual.innerText = els.video.currentTime.toFixed(3);

                if (state.isPlaying && state.localVideoLoaded) {
                    
                    // --- NEW: MOVE THE MARKER ---
                    // Math: (Current Time / Total Duration) * 100
                    // This moves the dot across the screen exactly matching the video progress
                    const pct = (els.video.currentTime / els.video.duration) * 100;
                    
                    // Safety: prevent it going off screen
                    if(pct >= 0 && pct <= 100) {
                        els.marker.style.left = pct + "%";
                    }

                    // --- DRIFT LOGIC (Keep this as it was) ---
                    const driftSec = Math.abs(els.video.currentTime - targetVideoTimeSec);
                    els.debug.drift.innerText = driftSec.toFixed(3) + "s";
                    
                    if (driftSec > 0.3) {
                         if (targetVideoTimeSec < els.video.duration && targetVideoTimeSec > 0) {
                             els.video.currentTime = targetVideoTimeSec;
                         }
                    }
                    if (els.video.paused) els.video.play();
                }
            }
            requestAnimationFrame(syncLoop);
        }
                init();
    </script>
</body>

</html>